@page "/music/add"
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Large" Class="music-container">
    <MudPaper Class="music-hero pa-6 mb-6" Elevation="1">
        <MudStack Direction="Row" Spacing="3" AlignItems="AlignItems.Center">
            <MudAvatar Icon="@Icons.Material.Filled.LibraryMusic" Size="Size.Large" Class="music-hero__avatar"/>
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Class="music-hero__title">添加音乐</MudText>
                <MudText Typo="Typo.subtitle1" Class="music-hero__subtitle">上传音频、封面与歌词，一次性完成音乐素材的整理</MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    <MudOverlay Visible="_isPosting" ZIndex="9999" DarkBackground="true">
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true"/>
    </MudOverlay>

    <EditForm Model="_t" OnValidSubmit="PostMusicAsync">
        <MudGrid Justify="Justify.Center">
            <MudItem xs="12" md="10" lg="8">
                <MudPaper Elevation="3" Class="music-form-card pa-6">
                    <DataAnnotationsValidator/>
                    <MudStack Spacing="4">
                        <section class="upload-block">
                            <InputFile OnChange="OnMusicChanged" id="fileMusic" hidden accept="@(string.Join(',', _musicExtensions.Select(x => '.' + x)))"/>
                            <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="upload-block__header">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h6">音频文件</MudText>
                                    <MudText Typo="Typo.body2" Class="upload-block__hint">支持批量选择，自动识别格式与大小</MudText>
                                </MudStack>
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Class="upload-block__button"
                                           for="fileMusic">
                                    选择音乐文件
                                </MudButton>
                            </MudStack>
                            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true" Class="upload-alert">
                                支持格式：@string.Join("、", _musicExtensions.Select(x => x.ToUpperInvariant()))
                            </MudAlert>
                            <MudPaper Class="file-panel" Elevation="0">
                                @if (!_selectMusic.Any())
                                {
                                    <MudText Typo="Typo.body2" Class="file-panel__placeholder">暂未选择文件</MudText>
                                }
                                else
                                {
                                    <MudList Dense="true" T="string" Class="file-list">
                                        @foreach (var file in _selectMusic)
                                        {
                                            <MudListItem @key="@file" Class="file-list__item">
                                                <MudChip Color="Color.Primary" Variant="Variant.Filled" Class="file-chip">@(file.Key.Split(".").Last())</MudChip>
                                                <span class="file-list__name">@file.Key</span>
                                                <MudText Typo="Typo.caption" Class="file-list__size">@(file.Value.FileSize())</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudPaper>
                        </section>

                        <MudDivider Class="section-divider"/>

                        <section class="upload-block">
                            <InputFile OnChange="OnCoverChanged" id="fileCover" hidden accept="@(string.Join(',', AppTools.ImageExtensions.Select(x => '.' + x)))"/>
                            <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="upload-block__header">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h6">封面图片</MudText>
                                    <MudText Typo="Typo.body2" Class="upload-block__hint">推荐上传正方形高清封面，自动预览效果</MudText>
                                </MudStack>
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Class="upload-block__button"
                                           for="fileCover">
                                    选择封面图片
                                </MudButton>
                            </MudStack>
                            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Dense="true" Class="upload-alert">
                                支持格式：@string.Join("、", AppTools.ImageExtensions.Select(x => x.ToUpperInvariant()))
                            </MudAlert>
                            <MudPaper Class="file-panel" Elevation="0">
                                <MudList Dense="true" T="string" Class="file-list">
                                    <Preview></Preview>
                                    @if (!_selectCover.Any())
                                    {
                                        <MudListItem Class="file-list__item" @key="Guid.NewGuid()">
                                            <MudText Typo="Typo.body2" Class="file-panel__placeholder">暂未选择封面</MudText>
                                        </MudListItem>
                                    }
                                    else
                                    {
                                        @foreach (var file in _selectCover)
                                        {
                                            <MudListItem @key="@file" Class="file-list__item">
                                                <MudChip Color="Color.Secondary" Variant="Variant.Filled" Class="file-chip">@(file.Key.Split(".").Last())</MudChip>
                                                <span class="file-list__name">@file.Key</span>
                                                <MudText Typo="Typo.caption" Class="file-list__size">@(file.Value.FileSize())</MudText>
                                            </MudListItem>
                                        }
                                    }
                                </MudList>
                            </MudPaper>
                        </section>

                        <MudDivider Class="section-divider"/>

                        <section class="upload-block">
                            <InputFile OnChange="OnLrcChanged" id="fileLrc" hidden accept=".lrc"/>
                            <MudStack Direction="Row" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="upload-block__header">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.h6">歌词文件</MudText>
                                    <MudText Typo="Typo.body2" Class="upload-block__hint">支持标准 .LRC 歌词文件，自动展示文本</MudText>
                                </MudStack>
                                <MudButton HtmlTag="label"
                                           Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Class="upload-block__button"
                                           for="fileLrc">
                                    上传歌词
                                </MudButton>
                            </MudStack>
                            <MudPaper Class="file-panel" Elevation="0">
                                @if (!_selectLrc.Any())
                                {
                                    <MudText Typo="Typo.body2" Class="file-panel__placeholder">暂未选择歌词</MudText>
                                }
                                else
                                {
                                    <MudList Dense="true" T="string" Class="file-list">
                                        @foreach (var file in _selectLrc)
                                        {
                                            <MudListItem @key="@file" Class="file-list__item">
                                                <MudChip Color="Color.Info" Variant="Variant.Filled" Class="file-chip">@(file.Key.Split(".").Last())</MudChip>
                                                <span class="file-list__name">@file.Key</span>
                                                <MudText Typo="Typo.caption" Class="file-list__size">@(file.Value.FileSize())</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudPaper>
                        </section>

                        <MudDivider Class="section-divider"/>

                        <section class="group-block">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.h6">分类与标签</MudText>
                                <MudText Typo="Typo.body2" Class="upload-block__hint">选择已存在的分组或输入新的标签方便管理</MudText>
                            </MudStack>
                            <MudSelect T="string"
                                       HelperText="分组"
                                       Immediate="true"
                                       Label="请选择分组"
                                       MultiSelection="true"
                                       @bind-SelectedValues="_selectedGroups"
                                       Variant="Variant.Outlined"
                                       Class="group-select">
                                @foreach (var group in _groups)
                                {
                                    <MudSelectItem T="string" Value="@group">@group</MudSelectItem>
                                }
                            </MudSelect>
                            <MudTextField T="string"
                                          Immediate="true"
                                          Label="补充分组"
                                          @bind-value="_addGroup"
                                          For="@(() => _addGroup)"
                                          Variant="Variant.Outlined"
                                          Placeholder="输入新的分组名称"
                                          Class="group-input">
                            </MudTextField>
                        </section>

                        <MudStack Direction="Row" Justify="Justify.FlexEnd" Spacing="2" Class="actions-row">
                            <MudButton Variant="Variant.Outlined" Color="Color.Default" Href="/music">返回列表</MudButton>
                            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Disabled="_isPosting" Color="Color.Primary" Class="submit-button">
                                @if (_isPosting)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                                    <MudText Class="ms-2">正在上传</MudText>
                                }
                                else
                                {
                                    <MudText>开始上传</MudText>
                                }
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>